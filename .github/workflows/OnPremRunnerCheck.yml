name: CI for Razor Pages on Self-Hosted Runner

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-test-deploy:
    runs-on: self-hosted  # Use your self-hosted runner

    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup .NET SDK - not required as .NET SDK for 8.x.x installed.
      #- name: Setup .NET
      #  uses: actions/setup-dotnet@v3
      #  with:
      #    dotnet-version: '8.0.x' # Adjust to your target framework
      #    install-dir: '${{ github.workspace }}\\.dotnet' # Custom directory inside workspace

      # 3. Cache NuGet packages (optional but recommended)
      #- name: Cache NuGet packages
      #  uses: actions/cache@v3
      #  with:
      #    path: ~/.nuget/packages
      #    key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
      #    restore-keys: |
      #      ${{ runner.os }}-nuget-

      # 4. Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      - name: Restore libman
        run: libman restor

      # 5. Build the project
      - name: Build
        run: dotnet build --configuration Release --no-restore

      # 6. Run tests
      #- name: Test
      #  run: dotnet test --no-build --verbosity normal

      # 7. Publish the app
      - name: Publish
        run: dotnet publish -c Release -o ./publish


      # 8. Deploy to IIS (copy files to IIS site folder)
      - name: Deploy to IIS
        run: |
          # Define IIS site path (adjust to your environment)
          $env:IIS_PATH="D:\\Websites\\GitHubActionsOnPremRazorPages"
          
          echo "Stopping IIS site..."
          powershell -Command "Import-Module WebAdministration; Stop-WebSite -Name 'GitHubActionsOnPremRazorPages'"

          echo "Copying files..."
          robocopy ./publish $env:IIS_PATH /MIR

          # requires account running the service to have permissions to the following folder: %windir%\System32\inetsrv\config.
          # so that is can read the IIS configuration files (such as redirection.config)
          echo "Starting IIS site..."
          powershell -Command "Import-Module WebAdministration; Start-WebSite -Name 'GitHubActionsOnPremRazorPages'"


#name: SelfRunnerCheck

#on:
#  push:
#    branches: [ "master" ]
#  pull_request:
#    branches: [ "master" ]

#jobs:
  #build:
    #runs-on: self-hosted
    #steps:
      #- run: echo "Running on my on-prem runner"
      #- uses: actions/checkout@v4
      #- name: Setup .NET
        #uses: actions/setup-dotnet@v4
        #with:
        #  dotnet-version: 8.0.x
      #- name: Restore dependencies
      #  run: dotnet restore
      #- name: Build
      #  run: dotnet build --no-restore
      #- name: Test
      #  run: dotnet test --no-build --verbosity normal
      #- name: Deploy locally
      #  run: |
      #    Copy-Item -Path "./publish/*" -Destination "D:\Websites\GitHubActionsOnPremRazorPages" -Recurse -Force
      #    Restart-WebAppPool "GitHubActionsOnPremRazorPages"

